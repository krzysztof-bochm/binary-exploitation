#include <stdlib.h>
#include <string.h>
#include <stddef.h>
#include <stdio.h>

#include <assert.h>

typedef struct {
    char username[16];
    char password[16];
    char user_type; 
} User;


int get_number() {
    char buffor[16];
    fgets(buffor, sizeof(buffor), stdin);
    return atoi(buffor);
}

int main() {
    setvbuf(stdout, NULL, _IONBF, 0);

    size_t user_count = 0;
    User* users[16] = {};
    User* logged_as = 0;

    while(1) {
        printf(
                "What do you want to do?\n"
                "\t(1) - register new user\n"
                "\t(2) - login\n"
                "\t(3) - logout\n"
                "\t(4) - delete account\n"
                "\t(0) - exit\n"
                "> "
            );
        
        int choice = get_number();

        switch(choice) {
            case 1: {
                assert(user_count < 16);
                
                users[user_count] = malloc(sizeof(User));
            
                printf("username > ");
                fgets(users[user_count]->username, 1024, stdin); // overflow

                printf("password > ");
                fgets(users[user_count]->password, 16, stdin);

                users[user_count]->user_type = 'U';        

                user_count++;
                break; 
            }
            case 2: {
                if(!logged_as) {
                    char buffor[1024];
                    printf("username > ");
                    fgets(buffor, 1024, stdin);

                    for(size_t i = 0; i < user_count; i++) {
                        if(strcmp(buffor, users[i]->username) == 0) {
                            printf("password > ");
                            fgets(buffor, 1024, stdin);

                            if(strcmp(buffor, users[i]->password) == 0) {
                                logged_as = users[i];            
                            
                                if(logged_as->user_type == 'A') {
                                    puts("CONGRATZ!");
                                    return 0;
                                }
                            }

                            break;
                        }
                    }
                
                    puts(logged_as ? "Success!" : "Fail!");
                }
                break;
            }
            case 3: {
                logged_as = 0;
                break;        
            }
            case 4: {
                if(logged_as) {
                    size_t i = 0;
                    while(users[i++] != logged_as);
                    while((users[i-1] = users[i]) && (++i < user_count));
                    users[user_count--] = 0;
                    free(logged_as);
                    logged_as = 0;
                }
                break;        
            }
            default: return 0;
        }        
    }
}
