#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <stddef.h>


typedef enum {
    Playing,
    XWins,
    OWins,
    Stelemate
} GameState;

void __attribute__ ((noinline) )read_string(char* buffor) {
    read(0, buffor, 4096);
}

int __attribute__ ((noinline)) read_square() {
   char buffor[16];
   read_string(buffor);
   return atoi(buffor) - 1; 
}

void print_board(char* board) {
    for(size_t i = 0; i < 3; i++) {
        printf("%.3s\n", board);
        board += 3;
    }
}

char is_board_full(char* board) {
    for(size_t i = 0; i < 9; i++) {
        if(board[i] == ' ') return 0;        
    }
    return 1;
}

char get_winning_player(char* board) {
    // it is ugly function but it should yield more code than hardcoding ifs 
    char ch = board[0];
    for(size_t i = 4; i < 9; i += 4) {
        if(board[i] != ch) ch = ' ';    
    }

    if(ch != ' ') return ch;

    ch = board[2];
    for(size_t i = 4; i < 7; i += 2) {
        if(board[i] != ch) ch = ' ';    
    }

    if(ch != ' ') return ch;
    
    for(size_t i = 0; i < 3; i++) {
        char vertical = board[i];
        char horizontal = board[3 * i]; 

        for(size_t j = 1; j < 3; j++) {
             if(board[i + 3 * j] != vertical) vertical = ' ';
             if(board[3 * i + j] != horizontal) horizontal = ' ';
        }

        if(horizontal != ' ') return horizontal;
        if(vertical != ' ') return vertical;
    }
    
    return ' ';
}

GameState get_game_state(char* board) {
    char winning_player = get_winning_player(board);

    if(winning_player == 'X') {
        return XWins;
    } else if(winning_player == 'O') {
        return OWins;
    } else if(is_board_full(board)) {
        return Stelemate;
    } else {
        return Playing;
    }
}

GameState min_max_game_state(char* board, char player_turn, int* best_move) {
    GameState best_result = player_turn ? OWins : XWins;
    int best_square = -1;

    for(size_t i = 0; i < 9; i ++) {
        if(board[i] == ' ') {
            board[i] = player_turn ? 'X' : 'O';

            int best_move;
            GameState current_state = get_game_state(board);
            if(current_state == Playing) {
                current_state = min_max_game_state(board, !player_turn, &best_move);
            }

            if(best_square == -1) {
                best_result = current_state;
                best_square = i;
            } else if(player_turn) {
                if (best_result == OWins) {
                    best_result = current_state;
                    best_square = i;
                } else if(best_result == Stelemate && current_state == XWins) {
                    best_result = current_state;
                    best_square = i;
                }
            } else {
                if (best_result == XWins) {
                    best_result = current_state;
                    best_square = i;
                } else if(best_result == Stelemate && current_state == OWins) {
                    best_result = current_state;
                    best_square = i;
                }
            }

            board[i] = ' '; 
        }
    }

    *best_move = best_square;
    return best_result;
}

int get_bot_move(char* board) {
    int ret;
    min_max_game_state(board, 0, &ret);
    return ret;  
}

int main() {
setvbuf(stdout, NULL, _IONBF, 0);



    GameState state = Playing;
    //               _012345678  
    char board[10] = "         ";
    char player_turn = 1;



    printf("System address: %p\n", system);

    while(state == Playing) {
        int square;
        char symbol;
       
        print_board(board);

        if(player_turn) {
            symbol = 'X';
            do {
                printf("your move > ");
                square = read_square(); 
            } while(square < 0 || square > 8 || board[square] != ' ');
        } else {
            symbol = 'O';
            puts("computer's move");
            square = get_bot_move(board);
            printf("%i\n", square);
        }
        
        board[square] = symbol;
        state = get_game_state(board); 

        player_turn = !player_turn;
    }

    print_board(board);

    if(state == XWins) {
        puts("You win!");
        abort(); // how did it even happen
    } else if(state == OWins) {
        puts("You lose");
    } else {
        puts("Stelemate, as expected");
    }
}
